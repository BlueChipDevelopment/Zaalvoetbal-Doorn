<div class="kalender-container">
  <!-- Loading spinner voor initiÃ«le data -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>Laden van wedstrijden en spelers...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="errorMessage" class="error-banner mat-elevation-z2">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
    <button mat-icon-button (click)="errorMessage = null">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Main content - only shown when not loading -->
  <mat-card class="kalender-card" *ngIf="!isLoading">
    <mat-card-content>
      <!-- Player selection -->
      <mat-form-field appearance="fill" class="player-select" subscriptSizing="dynamic">
        <mat-label>Selecteer Speler</mat-label>
        <mat-select [(ngModel)]="selectedPlayer" (selectionChange)="onPlayerSelectionChange()" name="player">
          <mat-option *ngFor="let player of players" [value]="player.name">
            {{ player.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="playerSelectError">{{ playerSelectError }}</mat-error>
      </mat-form-field>

      <!-- Prompt to select player -->
      <div *ngIf="!selectedPlayer && players.length > 0" class="select-prompt">
        <p>Selecteer je naam om je aanwezigheid voor toekomstige wedstrijden door te geven.</p>
      </div>

      <!-- No players found -->
      <div *ngIf="players.length === 0">
        <p>Geen spelers gevonden.</p>
      </div>

      <!-- No future matches -->
      <div *ngIf="selectedPlayer && futureMatches.length === 0 && !isLoadingStatus">
        <div class="info-message">
          <mat-icon>info</mat-icon>
          <p>Er zijn momenteel geen toekomstige wedstrijden gepland.</p>
        </div>
      </div>

      <!-- Future matches list -->
      <div *ngIf="selectedPlayer && futureMatches.length > 0" class="matches-container">
        <div *ngIf="isLoadingStatus" class="loading-status">
          <mat-progress-spinner mode="indeterminate" diameter="30"></mat-progress-spinner>
          <span>Laden van aanwezigheid status...</span>
        </div>

        <div class="matches-cards" *ngIf="!isLoadingStatus">
          <ng-container *ngFor="let match of futureMatches; let last = last; trackBy: trackByMatchDate">
            <mat-card class="match-card" *ngIf="match.parsedDate">
              <mat-card-content class="match-content">
              <div class="match-info">
                <h3 class="match-date">{{ formatDateForDisplay(match.parsedDate) }}</h3>
                <div class="match-details">
                  <span class="match-time">{{ match.time }}</span>
                  <span class="match-location">{{ match.location }}</span>
                  <span class="match-number" *ngIf="match.matchNumber">Wedstrijd #{{ match.matchNumber }}</span>
                </div>
                
                <div class="presence-counts" *ngIf="!isLoadingCounts && !isUpdatingCounts(match.formattedDate)">
                  <button 
                    mat-stroked-button 
                    class="count-button present-count"
                    (click)="toggleMatchExpansion(match.formattedDate)"
                    matTooltip="Klik om spelers te bekijken">
                    <mat-icon>groups</mat-icon>
                    <span>{{ getPresenceCounts(match.formattedDate).aanwezig }}</span>
                  </button>
                  <button 
                    mat-stroked-button 
                    class="count-button absent-count"
                    (click)="toggleMatchExpansion(match.formattedDate)"
                    matTooltip="Klik om spelers te bekijken">
                    <mat-icon>person_off</mat-icon>
                    <span>{{ getPresenceCounts(match.formattedDate).afwezig }}</span>
                  </button>
                  <button 
                    mat-stroked-button 
                    class="count-button no-response-count"
                    (click)="toggleMatchExpansion(match.formattedDate)"
                    matTooltip="Klik om spelers te bekijken">
                    <mat-icon>help_outline</mat-icon>
                    <span>{{ getAttendanceDetails(match.formattedDate)?.geenReactie?.length || 0 }}</span>
                  </button>
                </div>
                
                <div class="presence-counts" *ngIf="isLoadingCounts">
                  <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
                  <span class="loading-text">Laden aantallen...</span>
                </div>
                
                <div class="presence-counts" *ngIf="!isLoadingCounts && isUpdatingCounts(match.formattedDate)">
                  <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
                  <span class="loading-text">Bijwerken...</span>
                </div>
              </div>                <div class="attendance-controls">
                  <div *ngIf="isSaving(match.formattedDate)" class="saving-indicator">
                    <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
                    <span>Opslaan...</span>
                  </div>

                  <mat-button-toggle-group 
                    *ngIf="!isSaving(match.formattedDate)"
                    class="attendance-toggle"
                    [value]="getAttendanceStatus(match.formattedDate)"
                    (change)="setAttendance(match.formattedDate, $event.value)"
                    [disabled]="isSaving(match.formattedDate)">
                    
                    <mat-button-toggle value="aanwezig" class="toggle-present">
                      <mat-icon>check_circle</mat-icon>
                      Aanwezig
                    </mat-button-toggle>
                    
                    <mat-button-toggle value="afwezig" class="toggle-absent">
                      <mat-icon>cancel</mat-icon>
                      Afwezig
                    </mat-button-toggle>
                  </mat-button-toggle-group>
                </div>
              </mat-card-content>

              <!-- Expandable player details -->
              <div class="player-details" 
                   *ngIf="isMatchExpanded(match.formattedDate)"
                   [@slideInOut]>
                <ng-container *ngIf="getAttendanceDetails(match.formattedDate) as details">
                  <div class="attendance-section">
                    <!-- Present players -->
                    <mat-list *ngIf="details.aanwezig.length > 0" class="player-list present-list">
                      <div matSubheader class="present-subheader">
                        <mat-icon>check_circle</mat-icon>
                        Aanwezig ({{ details.aanwezig.length }})
                      </div>
                      <div class="player-chips">
                        <mat-chip-set>
                          <mat-chip *ngFor="let player of details.aanwezig" class="player-chip present-chip">
                            <div class="chip-content">
                              <span class="player-avatar"></span>
                              <div class="player-info">
                                <span class="player-name">{{ player.name }}</span>
                                <span class="player-position" *ngIf="player.position">{{ player.position }}</span>
                              </div>
                            </div>
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </mat-list>

                    <!-- Absent players -->
                    <mat-list *ngIf="details.afwezig.length > 0" class="player-list absent-list">
                      <div matSubheader class="absent-subheader">
                        <mat-icon color="warn">cancel</mat-icon>
                        Afwezig ({{ details.afwezig.length }})
                      </div>
                      <div class="player-chips">
                        <mat-chip-set>
                          <mat-chip *ngFor="let player of details.afwezig" class="player-chip absent-chip">
                            <div class="chip-content">
                              <span class="player-avatar"></span>
                              <div class="player-info">
                                <span class="player-name">{{ player.name }}</span>
                                <span class="player-position" *ngIf="player.position">{{ player.position }}</span>
                              </div>
                            </div>
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </mat-list>

                    <!-- No response players -->
                    <mat-list *ngIf="details.geenReactie.length > 0" class="player-list no-response-list">
                      <div matSubheader class="no-response-subheader">
                        <mat-icon>help</mat-icon>
                        Geen reactie ({{ details.geenReactie.length }})
                      </div>
                      <div class="player-chips">
                        <mat-chip-set>
                          <mat-chip *ngFor="let player of details.geenReactie" class="player-chip no-response-chip">
                            <div class="chip-content">
                              <span class="player-avatar"></span>
                              <div class="player-info">
                                <span class="player-name">{{ player.name }}</span>
                                <span class="player-position" *ngIf="player.position">{{ player.position }}</span>
                              </div>
                            </div>
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </mat-list>
                  </div>
                </ng-container>
              </div>
            </mat-card>
            
            <mat-divider *ngIf="!last" class="card-divider"></mat-divider>
          </ng-container>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
